<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/styles.css">
    <title>Dog Breed Classifier</title>
</head>
<body>
    <h1>Dog Breed Classifier</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="files" accept="image/*" multiple required>
        <button type="submit">Predict</button>
    </form>

    <!-- Progress Bar -->
    <div id="uploadProgressContainer" style="display: none;">
        <label for="uploadProgress">Uploading files...</label>
        <progress id="uploadProgress" value="0" max="100"></progress>
        <span id="progressPercentage">0%</span>
    </div>

    <div id="results"></div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const files = formData.getAll('files');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressPercentage = document.getElementById('progressPercentage');
            const uploadProgressContainer = document.getElementById('uploadProgressContainer');
            const resultsDiv = document.getElementById('results');

            // Show the progress bar container
            uploadProgressContainer.style.display = 'block';

            // Reset progress
            uploadProgress.value = 0;
            progressPercentage.textContent = '0%';

            // Create a new FormData object to hold the files
            const xhr = new XMLHttpRequest();

            // Track the upload progress
            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    uploadProgress.value = percentComplete;
                    progressPercentage.textContent = `${Math.round(percentComplete)}%`;
                }
            };

            // Handle the response after the upload is finished
            xhr.onload = async () => {
                // Hide the progress bar after the upload is complete
                uploadProgressContainer.style.display = 'none';

                const data = await xhr.responseText;
                const responseData = JSON.parse(data);
                resultsDiv.innerHTML = ''; // Clear previous results

                if (responseData.results) {
                    responseData.results.forEach(result => {
                        const predictionDiv = document.createElement('div');
                        predictionDiv.className = 'prediction';

                        if (result.error) {
                            predictionDiv.textContent = `Error for ${result.filename}: ${result.error}`;
                        } else {
                            const topBreedsHTML = result.top_breeds.map((breedInfo, index) => {
                                if (index === 0) {
                                    return `
                                        <li class="top-breed">
                                            ${breedInfo.breed}: ${(breedInfo.probability * 100).toFixed(2)}%
                                        </li>
                                    `;
                                }
                                return `
                                    <li>
                                        ${breedInfo.breed}: ${(breedInfo.probability * 100).toFixed(2)}%
                                    </li>
                                `;
                            }).join('');

                            predictionDiv.innerHTML = `
                                <h3>${result.filename}</h3>
                                <p><strong>Top Predictions:</strong></p>
                                <ul>
                                    ${topBreedsHTML}
                                </ul>
                                <img src="data:image/jpeg;base64,${result.image}" alt="${result.filename}">
                            `;
                        }
                        resultsDiv.appendChild(predictionDiv);
                    });
                }
            };

            // Prepare and send the request
            xhr.open('POST', '/predict');
            xhr.send(formData);
        });
    </script>
</body>
</html>
