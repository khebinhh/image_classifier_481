<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/styles.css">
    <title>Dog Breed Classifier</title>
</head>
<body>
    <h1>Dog Breed Classifier</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="files" accept="image/*" multiple required>
        <button type="submit">Predict</button>
    </form>

    <!-- Progress Bar -->
    <div id="uploadProgressContainer" style="display: none;">
        <label for="uploadProgress">Uploading files...</label>
        <progress id="uploadProgress" value="0" max="100"></progress>
        <span id="progressPercentage">0%</span>
    </div>

    <div id="results"></div>

    <script>
        
        
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const files = formData.getAll('files');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressPercentage = document.getElementById('progressPercentage');
            const uploadProgressContainer = document.getElementById('uploadProgressContainer');
            const resultsDiv = document.getElementById('results');

            // Initialize a list for previous results if it doesn't exist
            if (!window.previousResults) {
                window.previousResults = [];
            }

            // Show the progress bar container
            uploadProgressContainer.style.display = 'block';

            // Reset progress
            uploadProgress.value = 0;
            progressPercentage.textContent = '0%';

            // Create a new FormData object to hold the files
            const xhr = new XMLHttpRequest();

            // Track the upload progress
            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    uploadProgress.value = percentComplete;
                    progressPercentage.textContent = `${Math.round(percentComplete)}%`;
                }
            };

            // Handle the response after the upload is finished
            xhr.onload = async () => {
                // Hide the progress bar after the upload is complete
                uploadProgressContainer.style.display = 'none';

                const data = await xhr.responseText;
                const responseData = JSON.parse(data);
                resultsDiv.innerHTML = ''; // Clear previous results

    // Append new results to previousResults
                window.previousResults.push(...responseData.results);
                // Render all results: new + previous
                window.previousResults.forEach(result => {
                    const predictionDiv = document.createElement('div');
                    predictionDiv.className = 'prediction';
    if (result.error) {
                        predictionDiv.textContent = `Error for ${result.filename}: ${result.error}`;
                    } else {
                        const topBreed = result.top_breeds[0].breed;
                        const formattedReferenceBreedName = topBreed.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
                        const referenceImagePath = `/static/breed_images/${topBreed}.jpg`;
                        // Check if the reference image file exists
                        fetch(referenceImagePath)
                            .then(response => {
                                if (response.ok) {
                                    console.log(`Reference image found for ${formattedReferenceBreedName}`);
                                } else {
                                    console.warn(`Reference image NOT found for ${formattedReferenceBreedName}`);
                                }
                            })
                            .catch(error => {
                                console.error(`Error loading reference image for ${formattedReferenceBreedName}: ${error}`);
                            });
                        const topBreedsHTML = result.top_breeds.map((breedInfo, index) => {
                            const formattedBreedName = breedInfo.breed.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
                            return `
                                <li${index === 0 ? ' class="top-breed"' : ''}>
                                    ${formattedBreedName}: ${(breedInfo.probability * 100).toFixed(2)}%
                                </li>
                            `;
                        }).join('');
                        predictionDiv.innerHTML = `
                            <p><strong>Top Predictions:</strong></p>
                            <ul>${topBreedsHTML}</ul>
                            <img src="data:image/jpeg;base64,${result.image}" alt="${result.filename}" class="uploaded-img">
                            <h3>${result.filename}</h3>
                            <p><strong>Reference Image for ${topBreed.replace(/_/g, ' ')}:</strong></p>
                            <img src="${referenceImagePath}" alt="Reference Image" class="reference-img">
                        `;
                    }
                    resultsDiv.appendChild(predictionDiv);
                });
            };
            xhr.open('POST', '/predict');
            xhr.send(formData);
        });
    </script>
</body>
</html>
